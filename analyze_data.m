clc;clear;

do_cal = 0;

if do_cal == 1
    
    n_bins = 256;

    H_gt_r = zeros([n_bins, 1]);
    H_gt_g = zeros([n_bins, 1]);
    H_gt_b = zeros([n_bins, 1]);

    H_br_r = zeros([n_bins, 1]);
    H_br_g = zeros([n_bins, 1]);
    H_br_b = zeros([n_bins, 1]);

    gt_dir = '/data/datasets/TEXT_DEBLUR/train';
    br_dir = gt_dir;
    files = dir([gt_dir '/*orig.png']);

    len = length(files);

    idx = randperm(len);
    files = files(idx);

    N = 5000;
    
    if len < N
        N = len;
    end
    
    files = files(1:N);

    example = imread([gt_dir '/' files(1).name]);
    [H, W] = size(example);
        
    for i=1:N
        gt_name = files(i).name;
        br_name = replace(gt_name, 'orig', 'blur');

        gt = imread([gt_dir '/' gt_name]);
        br = imread([br_dir '/' br_name]);

        gt = 255 - gt;
        br = 255 - br;

        [H, W] = size(gt);

        gt_r = gt(:,:,1);
        gt_g = gt(:,:,2);
        gt_b = gt(:,:,3);

        h_gt_r = imhist(gt_r, n_bins);
        h_gt_g = imhist(gt_g, n_bins);
        h_gt_b = imhist(gt_b, n_bins);

        H_gt_r = H_gt_r + h_gt_r;
        H_gt_g = H_gt_g + h_gt_g;
        H_gt_b = H_gt_b + h_gt_b;

        br_r = br(:,:,1);
        br_g = br(:,:,2);
        br_b = br(:,:,3);

        h_br_r = imhist(br_r, n_bins);
        h_br_g = imhist(br_g, n_bins);
        h_br_b = imhist(br_b, n_bins);

        H_br_r = H_br_r + h_br_r;
        H_br_g = H_br_g + h_br_g;
        H_br_b = H_br_b + h_br_b;

        if mod(i,500) == 0
            i
        end
    end

    H_gt_r = H_gt_r / N / (H * W);
    H_gt_g = H_gt_g / N / (H * W);
    H_gt_b = H_gt_b / N / (H * W);

    H_br_r = H_br_r / N / (H * W);
    H_br_g = H_br_g / N / (H * W);
    H_br_b = H_br_b / N / (H * W);

else
    H_gt_b = [0.238777920740741;0.00741480222222222;0.00519327481481482;0.00419833333333333;0.00334166444444444;0.00285700814814815;0.00242841259259259;0.00214954888888889;0.00182284814814815;0.00147472888888889;0.00120493851851852;0.000977301481481482;0.000941794074074074;0.000705940000000000;0.000620720000000000;0.000625242222222222;0.000555514074074074;0.000530905185185185;0.000543493333333333;0.000475597777777778;0.000486519259259259;0.000446015555555556;0.000423740000000000;0.000423417037037037;0.000446452592592593;0.000472163703703704;0.000427216296296296;0.000383060000000000;0.000388442222222222;0.000395667407407407;0.000403654074074074;0.000402220000000000;0.000368349629629630;0.000337171111111111;0.000386466666666667;0.000329371851851852;0.000324222222222222;0.000328090370370370;0.000362788148148148;0.000332590370370370;0.000311093333333333;0.000352273333333333;0.000302326666666667;0.000301429629629630;0.000297722222222222;0.000294138518518519;0.000291614814814815;0.000298871111111111;0.000287432592592593;0.000293298518518519;0.000311206666666667;0.000400903703703704;0.000281769629629630;0.000277200740740741;0.000269613333333333;0.000271930370370370;0.000269214074074074;0.000330785185185185;0.000265440740740741;0.000263897037037037;0.000261710370370370;0.000270058518518519;0.000303072592592593;0.000320790370370370;0.000286381481481481;0.000256385925925926;0.000254692592592593;0.000256520740740741;0.000252825185185185;0.000270177777777778;0.000250661481481482;0.000248814074074074;0.000249308888888889;0.000245908148148148;0.000244478518518519;0.000246653333333333;0.000260866666666667;0.000259766666666667;0.000244685185185185;0.000241457777777778;0.000241091111111111;0.000241224444444444;0.000240285185185185;0.000240409629629630;0.000243637777777778;0.000240391851851852;0.000237237777777778;0.000236282962962963;0.000234002222222222;0.000232160000000000;0.000232592592592593;0.000234243703703704;0.000230561481481482;0.000228549629629630;0.000228936296296296;0.000226196296296296;0.000225396296296296;0.000222865185185185;0.000226031851851852;0.000222260000000000;0.000222946666666667;0.000224843703703704;0.000338958518518519;0.000224904444444444;0.000220347407407407;0.000220491111111111;0.000220362222222222;0.000223338518518519;0.000219240740740741;0.000222785185185185;0.000219888148148148;0.000218668888888889;0.000227885925925926;0.000246838518518519;0.000215339259259259;0.000215776296296296;0.000210700000000000;0.000212918518518519;0.000210046666666667;0.000209937777777778;0.000209357037037037;0.000219584444444444;0.000206414814814815;0.000207165185185185;0.000202904444444444;0.000201757037037037;0.000202339259259259;0.000216931851851852;0.000206167407407407;0.000203371111111111;0.000198969629629630;0.000198991111111111;0.000197955555555556;0.000194922962962963;0.000197142222222222;0.000195049629629630;0.000193154814814815;0.000192231851851852;0.000191753333333333;0.000192774814814815;0.000189626666666667;0.000188622222222222;0.000187360000000000;0.000186787407407407;0.000188526666666667;0.000185896296296296;0.000184808148148148;0.000182274814814815;0.000195554074074074;0.000183417037037037;0.000181553333333333;0.000178220000000000;0.000179577777777778;0.000182972592592593;0.000181298518518519;0.000178207407407407;0.000178188888888889;0.000176206666666667;0.000174019259259259;0.000177431851851852;0.000177018518518519;0.000174058518518519;0.000172798518518519;0.000174854074074074;0.000171748148148148;0.000173685185185185;0.000173153333333333;0.000171955555555556;0.000172438518518519;0.000172374814814815;0.000171825185185185;0.000170752592592593;0.000170303703703704;0.000171015555555556;0.000169543703703704;0.000169640000000000;0.000170462222222222;0.000172019259259259;0.000170976296296296;0.000177088888888889;0.000169166666666667;0.000170268888888889;0.000170967407407407;0.000170136296296296;0.000171037777777778;0.000168525925925926;0.000170737037037037;0.000169242222222222;0.000177966666666667;0.000170670370370370;0.000166709629629630;0.000170773333333333;0.000165956296296296;0.000165797037037037;0.000166451851851852;0.000165690370370370;0.000163678518518519;0.000164642962962963;0.000164806666666667;0.000164677777777778;0.000173543703703704;0.000163042962962963;0.000165250370370370;0.000165627407407407;0.000173319259259259;0.000163865185185185;0.000165163703703704;0.000164712592592593;0.000162828148148148;0.000184317777777778;0.000194756296296296;0.000177791111111111;0.000163050370370370;0.000163088888888889;0.000168220740740741;0.000164668888888889;0.000164000000000000;0.000165575555555556;0.000166846666666667;0.000167201481481481;0.000166517777777778;0.000168408148148148;0.000168431851851852;0.000168951851851852;0.000173516296296296;0.000171945185185185;0.000171700740740741;0.000174600000000000;0.000181924444444444;0.000169172592592593;0.000169554814814815;0.000172226666666667;0.000171549629629630;0.000172227407407407;0.000173112592592593;0.000172180000000000;0.000174861481481481;0.000178614074074074;0.000178632592592593;0.000183760740740741;0.000179028148148148;0.000187851851851852;0.000188014814814815;0.000187478518518519;0.000188920000000000;0.000200037037037037;0.000200021481481482;0.000205505925925926;0.000209175555555556;0.000214502962962963;0.000220196296296296;0.000236413333333333;0.000241814074074074;0.000251577777777778;0.000284157037037037;0.00369921333333333];
    H_gt_g = [0.238490868888889;0.00762936518518519;0.00522866074074074;0.00418453259259259;0.00334469111111111;0.00284575185185185;0.00248194296296296;0.00215107851851852;0.00182474740740741;0.00147661481481481;0.00120093629629630;0.000986110370370370;0.000859777777777778;0.000698648148148148;0.000622069629629630;0.000654183703703704;0.000577340740740741;0.000523113333333333;0.000493503703703704;0.000477986666666667;0.000491771851851852;0.000490335555555556;0.000453749629629630;0.000452112592592593;0.000417674074074074;0.000528100000000000;0.000410302222222222;0.000373985185185185;0.000395936296296296;0.000360734074074074;0.000399571111111111;0.000406244444444444;0.000371371851851852;0.000335350370370370;0.000384770370370370;0.000329572592592593;0.000322758518518519;0.000328754074074074;0.000359513333333333;0.000313767407407407;0.000311206666666667;0.000347653333333333;0.000303031111111111;0.000299105185185185;0.000296541481481481;0.000291065925925926;0.000295278518518519;0.000299274814814815;0.000295693333333333;0.000293541481481482;0.000308457037037037;0.000367877037037037;0.000284208888888889;0.000302857037037037;0.000271181481481482;0.000272279259259259;0.000269671111111111;0.000292994814814815;0.000272334814814815;0.000264037037037037;0.000266026666666667;0.000270045185185185;0.000303548888888889;0.000319970370370370;0.000279680000000000;0.000256625185185185;0.000253782222222222;0.000253751851851852;0.000248863703703704;0.000249661481481482;0.000247323703703704;0.000247204444444444;0.000253825925925926;0.000247245185185185;0.000245097777777778;0.000245014814814815;0.000247005925925926;0.000252090370370370;0.000241529629629630;0.000238746666666667;0.000237673333333333;0.000236356296296296;0.000235915555555556;0.000236437037037037;0.000238314814814815;0.000234734814814815;0.000232414814814815;0.000232648148148148;0.000231215555555556;0.000235670370370370;0.000229649629629630;0.000228626666666667;0.000227109629629630;0.000225610370370370;0.000226542222222222;0.000224275555555556;0.000224384444444444;0.000222965185185185;0.000225628888888889;0.000222692592592593;0.000221672592592593;0.000225625925925926;0.000228818518518519;0.000222730370370370;0.000219100740740741;0.000219286666666667;0.000220579259259259;0.000217442962962963;0.000217838518518519;0.000218351851851852;0.000219882222222222;0.000255234814814815;0.000216234074074074;0.000216168148148148;0.000214866666666667;0.000215345185185185;0.000209752592592593;0.000212286666666667;0.000210571851851852;0.000209444444444444;0.000209008888888889;0.000205345185185185;0.000205902962962963;0.000206831111111111;0.000203851111111111;0.000202516296296296;0.000205995555555556;0.000228911851851852;0.000209008148148148;0.000201199259259259;0.000199920740740741;0.000199268148148148;0.000199291111111111;0.000196122222222222;0.000198328888888889;0.000195840000000000;0.000194334074074074;0.000193394074074074;0.000192169629629630;0.000192377777777778;0.000189893333333333;0.000188869629629630;0.000188269629629630;0.000189204444444444;0.000191403703703704;0.000186673333333333;0.000185700740740741;0.000184497777777778;0.000197243703703704;0.000185865925925926;0.000183342222222222;0.000181758518518519;0.000187173333333333;0.000245866666666667;0.000189485925925926;0.000183697777777778;0.000183349629629630;0.000180525185185185;0.000179362222222222;0.000181318518518519;0.000181361481481481;0.000180475555555556;0.000179237777777778;0.000181200740740741;0.000178375555555556;0.000181481481481482;0.000179960000000000;0.000179332592592593;0.000178933333333333;0.000177624444444444;0.000177704444444444;0.000173905185185185;0.000173914074074074;0.000173044444444444;0.000169942962962963;0.000170645925925926;0.000170718518518519;0.000173289629629630;0.000170110370370370;0.000168848148148148;0.000168215555555556;0.000170096296296296;0.000170065925925926;0.000167878518518519;0.000169553333333333;0.000168066666666667;0.000170491851851852;0.000167234814814815;0.000168332592592593;0.000169020740740741;0.000163827407407407;0.000169638518518519;0.000169180740740741;0.000166622222222222;0.000166635555555556;0.000166062222222222;0.000164232592592593;0.000166814074074074;0.000168094074074074;0.000168460740740741;0.000167034074074074;0.000164617777777778;0.000166893333333333;0.000166193333333333;0.000176044444444444;0.000166311851851852;0.000166488148148148;0.000164152592592593;0.000164396296296296;0.000165763703703704;0.000168065185185185;0.000166227407407407;0.000163933333333333;0.000166581481481481;0.000170494814814815;0.000167059259259259;0.000166050370370370;0.000179234814814815;0.000169017777777778;0.000169491111111111;0.000167796296296296;0.000168556296296296;0.000169572592592593;0.000169850370370370;0.000177075555555556;0.000174585925925926;0.000173448148148148;0.000177525185185185;0.000183111851851852;0.000171706666666667;0.000171108888888889;0.000175750370370370;0.000172642962962963;0.000173167407407407;0.000174485185185185;0.000172782962962963;0.000173801481481482;0.000178308888888889;0.000178009629629630;0.000183001481481482;0.000178366666666667;0.000190857037037037;0.000191357777777778;0.000189414074074074;0.000189774814814815;0.000194737777777778;0.000207783703703704;0.000207062962962963;0.000216129629629630;0.000214364444444444;0.000219477037037037;0.000234614814814815;0.000240200740740741;0.000249074074074074;0.000263878518518519;0.00382041925925926];
    H_gt_r = [0.238680747407407;0.00760920444444444;0.00521572666666667;0.00421119185185185;0.00335770148148148;0.00284501851851852;0.00246533037037037;0.00218071851851852;0.00179719703703704;0.00148214370370370;0.00119775629629630;0.000982190370370370;0.000835216296296296;0.000694482222222222;0.000626846666666667;0.000610931851851852;0.000554172592592593;0.000520303703703704;0.000496225185185185;0.000495381481481482;0.000490175555555556;0.000484776296296296;0.000428489629629630;0.000420613333333333;0.000419280740740741;0.000461333333333333;0.000392591111111111;0.000370840000000000;0.000391282962962963;0.000377394074074074;0.000396477037037037;0.000391284444444444;0.000368114074074074;0.000346865185185185;0.000400302222222222;0.000328223703703704;0.000336731851851852;0.000327225925925926;0.000391201481481481;0.000313727407407407;0.000313576296296296;0.000349657037037037;0.000303054814814815;0.000312415555555556;0.000297439259259259;0.000294569629629630;0.000316202962962963;0.000298905925925926;0.000283767407407407;0.000289717037037037;0.000300949629629630;0.000371140000000000;0.000282670370370370;0.000277342962962963;0.000270906666666667;0.000271782222222222;0.000268482222222222;0.000293843703703704;0.000264256296296296;0.000264805185185185;0.000263270370370370;0.000269247407407407;0.000304422962962963;0.000322665185185185;0.000283017777777778;0.000275564444444444;0.000255755555555556;0.000256684444444444;0.000265221481481482;0.000254471111111111;0.000246266666666667;0.000245657037037037;0.000247286666666667;0.000244167407407407;0.000243011111111111;0.000243488148148148;0.000246964444444445;0.000249031111111111;0.000239556296296296;0.000237216296296296;0.000243213333333333;0.000235082962962963;0.000234665185185185;0.000235211111111111;0.000237912592592593;0.000234086666666667;0.000231992592592593;0.000231708148148148;0.000230077777777778;0.000227718518518519;0.000230405925925926;0.000229068148148148;0.000230978518518519;0.000226492592592593;0.000230692592592593;0.000224257777777778;0.000225422962962963;0.000223045185185185;0.000224967407407407;0.000222158518518519;0.000221636296296296;0.000227848148148148;0.000239043703703704;0.000222074814814815;0.000218229629629630;0.000218961481481481;0.000217074074074074;0.000216056296296296;0.000216302222222222;0.000216962222222222;0.000216949629629630;0.000215687407407407;0.000214432592592593;0.000215283703703704;0.000215113333333333;0.000252594074074074;0.000210146666666667;0.000212012592592593;0.000210038518518519;0.000209262222222222;0.000216082962962963;0.000204029629629630;0.000204275555555556;0.000204853333333333;0.000201496296296296;0.000199571851851852;0.000200414814814815;0.000216856296296296;0.000201377037037037;0.000197538518518519;0.000197378518518519;0.000196444444444444;0.000196912592592593;0.000193708148148148;0.000195720740740741;0.000193784444444444;0.000192875555555556;0.000191974814814815;0.000190931851851852;0.000191920740740741;0.000190692592592593;0.000188832592592593;0.000187464444444444;0.000187522222222222;0.000188645185185185;0.000186614814814815;0.000186511111111111;0.000183692592592593;0.000196417037037037;0.000184281481481481;0.000182204444444444;0.000179051111111111;0.000180626666666667;0.000184808888888889;0.000180055555555556;0.000179365925925926;0.000179160000000000;0.000176694074074074;0.000174516296296296;0.000176735555555556;0.000177211851851852;0.000173854814814815;0.000172982962962963;0.000174548888888889;0.000170611111111111;0.000172622222222222;0.000171894074074074;0.000170822962962963;0.000170132592592593;0.000171574074074074;0.000170590370370370;0.000169812592592593;0.000170628148148148;0.000174420740740741;0.000172888148148148;0.000172517777777778;0.000172317777777778;0.000174664444444444;0.000174076296296296;0.000171760000000000;0.000170939259259259;0.000173062962962963;0.000173159259259259;0.000171322962962963;0.000169984444444444;0.000164584444444444;0.000166310370370370;0.000164020000000000;0.000165316296296296;0.000177237777777778;0.000164138518518519;0.000168134074074074;0.000164248148148148;0.000164410370370370;0.000165147407407407;0.000164791111111111;0.000162473333333333;0.000164441481481481;0.000167138518518519;0.000164942222222222;0.000164759259259259;0.000162664444444444;0.000165002962962963;0.000164537037037037;0.000226954074074074;0.000165011851851852;0.000167302962962963;0.000164291851851852;0.000163677777777778;0.000165096296296296;0.000167595555555556;0.000165587407407407;0.000163562222222222;0.000164969629629630;0.000170282962962963;0.000167141481481482;0.000165999259259259;0.000179831851851852;0.000169420740740741;0.000169994074074074;0.000168791111111111;0.000169393333333333;0.000170394814814815;0.000170643703703704;0.000176731851851852;0.000175719259259259;0.000174431111111111;0.000178817037037037;0.000184923703703704;0.000174639259259259;0.000180422962962963;0.000182341481481481;0.000175022222222222;0.000174945185185185;0.000180862962962963;0.000174648888888889;0.000175406666666667;0.000179676296296296;0.000179493333333333;0.000184857037037037;0.000183611851851852;0.000191601481481481;0.000191908148148148;0.000199013333333333;0.000192549629629630;0.000196232592592593;0.000201982962962963;0.000207360740740741;0.000210503703703704;0.000215928888888889;0.000221392592592593;0.000237062222222222;0.000249281481481482;0.000253128148148148;0.000272977777777778;0.00391644000000000];
    
    gt_dir = '/data/datasets/TEXT_DEBLUR/test/orig';
    br_dir = replace(gt_dir, 'orig', 'n_00');
    files = dir([gt_dir '/*orig.png']);

    example = imread([gt_dir '/' files(1).name]);
    [H, W] = size(example);
    
    H_gt_b = floor(H_gt_b * H * W + 0.5);
    H_gt_g = floor(H_gt_g * H * W + 0.5);
    H_gt_r = floor(H_gt_r * H * W + 0.5);
    
    N = length(files);
    
    for i=1:N
        gt_name = files(i).name;
        br_name = replace(gt_name, 'orig', 'blur');

        gt = imread([gt_dir '/' gt_name]);
        br = imread([br_dir '/' br_name]);

        gt = 255 - gt;
        br = 255 - br;

        gt_r = gt(:,:,1);
        gt_g = gt(:,:,2);
        gt_b = gt(:,:,3);

        br_r = br(:,:,1);
        br_g = br(:,:,2);
        br_b = br(:,:,3);

        gt2_r = histeq(gt_r, H_gt_r);
        gt2_g = histeq(gt_g, H_gt_g);
        gt2_b = histeq(gt_b, H_gt_b);

        br2_r = histeq(br_r, H_gt_r);
        br2_g = histeq(br_g, H_gt_g);
        br2_b = histeq(br_b, H_gt_b);

        show_r = [gt_r gt2_r br_r br2_r];

        if mod(i,100) == 0
            i
        end
    end
    
end
